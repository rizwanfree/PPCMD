@{
    ViewData["Title"] = "Header Management";
}

<div class="container-fluid">
    @* <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>@ViewData["Title"]</h1>
    </div> *@

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs" id="headerTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="duty-types-tab" data-bs-toggle="tab" data-bs-target="#duty-types" type="button" role="tab" aria-controls="duty-types" aria-selected="true">
                Duty Types
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="payorder-headers-tab" data-bs-toggle="tab" data-bs-target="#payorder-headers" type="button" role="tab" aria-controls="payorder-headers" aria-selected="false">
                Payorder Headers
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="headerTabsContent">
        <!-- Duty Types Tab -->
        <div class="tab-pane fade show active" id="duty-types" role="tabpanel" aria-labelledby="duty-types-tab">
            <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Duty Types</h5>
                    <button type="button" class="btn btn-primary btn-sm" onclick="showDutyTypeModal()">
                        <i class="fas fa-plus"></i> Add Duty Type
                    </button>
                </div>
                <div class="card-body">
                    <table id="dutyTypesTable" class="table table-sm table-striped table-bordered" style="width:100%">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var dutyType in ViewBag.DutyTypes)
                            {
                                <tr>
                                    <td>@dutyType.Name</td>
                                    <td>@dutyType.Description</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="editDutyType(@dutyType.Id, '@dutyType.Name', '@dutyType.Description')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteDutyType(@dutyType.Id, '@dutyType.Name')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Payorder Headers Tab -->
        <div class="tab-pane fade" id="payorder-headers" role="tabpanel" aria-labelledby="payorder-headers-tab">
            <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Payorder Headers</h5>
                    <button type="button" class="btn btn-primary btn-sm" onclick="showPayorderHeaderModal()">
                        <i class="fas fa-plus"></i> Add Payorder Header
                    </button>
                </div>
                <div class="card-body">
                    <table id="payorderHeadersTable" class="table table-sm table-striped table-bordered" style="width:100%">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var header in ViewBag.PayorderHeaders)
                            {
                                <tr>
                                    <td>@header.Name</td>
                                    <td>@header.Description</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="editPayorderHeader(@header.Id, '@header.Name', '@header.Description')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="confirmDeletePayorderHeader(@header.Id, '@header.Name')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Duty Type Modal -->
<div class="modal fade" id="dutyTypeModal" tabindex="-1" aria-labelledby="dutyTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dutyTypeModalLabel">Add Duty Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="dutyTypeForm">
                <div class="modal-body">
                    <input type="hidden" id="dutyTypeId" name="Id" value="0">
                    <div class="mb-3">
                        <label for="dutyTypeName" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="dutyTypeName" name="Name" required maxlength="100">
                    </div>
                    <div class="mb-3">
                        <label for="dutyTypeDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="dutyTypeDescription" name="Description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Payorder Header Modal -->
<div class="modal fade" id="payorderHeaderModal" tabindex="-1" aria-labelledby="payorderHeaderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="payorderHeaderModalLabel">Add Payorder Header</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="payorderHeaderForm">
                <div class="modal-body">
                    <input type="hidden" id="payorderHeaderId" name="Id" value="0">
                    <div class="mb-3">
                        <label for="payorderHeaderName" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="payorderHeaderName" name="Name" required maxlength="100">
                    </div>
                    <div class="mb-3">
                        <label for="payorderHeaderDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="payorderHeaderDescription" name="Description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="deleteModalMessage">Are you sure you want to delete this item?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize DataTables
        $(document).ready(function () {
            $('#dutyTypesTable').DataTable({
                responsive: true,
                columnDefs: [
                    { orderable: false, targets: 2 } // Disable sorting on actions column
                ]
            });

            $('#payorderHeadersTable').DataTable({
                responsive: true,
                columnDefs: [
                    { orderable: false, targets: 2 } // Disable sorting on actions column
                ]
            });
        });

        // Duty Type Functions
        function showDutyTypeModal() {
            $('#dutyTypeId').val(0);
            $('#dutyTypeName').val('');
            $('#dutyTypeDescription').val('');
            $('#dutyTypeModalLabel').text('Add Duty Type');
            $('#dutyTypeModal').modal('show');
        }

        function editDutyType(id, name, description) {
            $('#dutyTypeId').val(id);
            $('#dutyTypeName').val(name);
            $('#dutyTypeDescription').val(description || '');
            $('#dutyTypeModalLabel').text('Edit Duty Type');
            $('#dutyTypeModal').modal('show');
        }

        // Payorder Header Functions
        function showPayorderHeaderModal() {
            $('#payorderHeaderId').val(0);
            $('#payorderHeaderName').val('');
            $('#payorderHeaderDescription').val('');
            $('#payorderHeaderModalLabel').text('Add Payorder Header');
            $('#payorderHeaderModal').modal('show');
        }

        function editPayorderHeader(id, name, description) {
            $('#payorderHeaderId').val(id);
            $('#payorderHeaderName').val(name);
            $('#payorderHeaderDescription').val(description || '');
            $('#payorderHeaderModalLabel').text('Edit Payorder Header');
            $('#payorderHeaderModal').modal('show');
        }

        // Delete Confirmation Functions
        let currentDeleteId = null;
        let currentDeleteType = null;

        function confirmDeleteDutyType(id, name) {
            currentDeleteId = id;
            currentDeleteType = 'dutyType';
            $('#deleteModalMessage').text(`Are you sure you want to delete the duty type "${name}"?`);
            $('#deleteModal').modal('show');
        }

        function confirmDeletePayorderHeader(id, name) {
            currentDeleteId = id;
            currentDeleteType = 'payorderHeader';
            $('#deleteModalMessage').text(`Are you sure you want to delete the payorder header "${name}"?`);
            $('#deleteModal').modal('show');
        }

        // Form Submissions
        $('#dutyTypeForm').on('submit', function (e) {
            e.preventDefault();
            saveDutyType();
        });

        $('#payorderHeaderForm').on('submit', function (e) {
            e.preventDefault();
            savePayorderHeader();
        });

        $('#confirmDeleteBtn').on('click', function () {
            if (currentDeleteType === 'dutyType') {
                deleteDutyType(currentDeleteId);
            } else if (currentDeleteType === 'payorderHeader') {
                deletePayorderHeader(currentDeleteId);
            }
        });

        // AJAX Functions
        async function saveDutyType() {
            const formData = {
                Id: $('#dutyTypeId').val(),
                Name: $('#dutyTypeName').val(),
                Description: $('#dutyTypeDescription').val()
            };

            try {
                const response = await fetch('/Header/SaveDutyType', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    $('#dutyTypeModal').modal('hide');
                    location.reload();
                } else {
                    alert('Error saving duty type');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving duty type');
            }
        }

        async function savePayorderHeader() {
            const formData = {
                Id: $('#payorderHeaderId').val(),
                Name: $('#payorderHeaderName').val(),
                Description: $('#payorderHeaderDescription').val()
            };

            try {
                const response = await fetch('/Header/SavePayorderHeader', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    $('#payorderHeaderModal').modal('hide');
                    location.reload();
                } else {
                    alert('Error saving payorder header');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving payorder header');
            }
        }

        async function deleteDutyType(id) {
            try {
                const response = await fetch(`/Header/DeleteDutyType/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    $('#deleteModal').modal('hide');
                    location.reload();
                } else {
                    alert('Error deleting duty type');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting duty type');
            }
        }

        async function deletePayorderHeader(id) {
            try {
                const response = await fetch(`/Header/DeletePayorderHeader/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    $('#deleteModal').modal('hide');
                    location.reload();
                } else {
                    alert('Error deleting payorder header');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting payorder header');
            }
        }
    </script>
}
