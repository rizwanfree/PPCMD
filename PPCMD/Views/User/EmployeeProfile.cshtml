@model PPCMD.Models.Employee
@{
    ViewData["Title"] = "Employee Profile";
    var isAdmin = User.IsInRole("Admin");
    var currentUserId = User.Identity?.Name; // not used for checks here; controller does proper authorization
}

<div class="max-w-6xl mx-auto p-6">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="mb-4 rounded-lg bg-green-50 border border-green-200 text-green-800 px-4 py-3">
            @TempData["SuccessMessage"]
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="mb-4 rounded-lg bg-red-50 border border-red-200 text-red-800 px-4 py-3">
            @TempData["ErrorMessage"]
        </div>
    }

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- Left: Profile card -->
        <aside class="lg:col-span-4">
            <div class="bg-white rounded-2xl shadow p-6">
                <div class="flex flex-col items-center text-center">
                    <img id="cardProfileImg" src="@(Model.ProfilePictureUrl ?? "/images/user.jpg")"
                         alt="Profile" class="h-28 w-28 object-cover rounded-full border-4 border-white shadow-md -mt-12 bg-gray-100" />
                    <div class="mt-4">
                        <h3 class="text-xl font-semibold text-gray-900">@($"{Model.FirstName} {Model.LastName}".Trim())</h3>
                        <p class="text-sm text-gray-500">@(!string.IsNullOrWhiteSpace(Model.Designation) ? Model.Designation : "—")</p>
                        <p class="text-sm text-gray-400 mt-1">@(!string.IsNullOrWhiteSpace(Model.Email) ? Model.Email : "—")</p>
                    </div>
                </div>

                <hr class="my-6" />

                <ul class="space-y-3 text-sm text-gray-700">
                    <li class="flex justify-between">
                        <span class="font-medium">Email</span>
                        <span class="text-gray-500">@(!string.IsNullOrWhiteSpace(Model.Email) ? Model.Email : "—")</span>
                    </li>
                    <li class="flex justify-between">
                        <span class="font-medium">Mobile</span>
                        <span class="text-gray-500">@(!string.IsNullOrWhiteSpace(Model.Mobile) ? Model.Mobile : "—")</span>
                    </li>
                    <li class="flex justify-between">
                        <span class="font-medium">CNIC</span>
                        <span class="text-gray-500">@(!string.IsNullOrWhiteSpace(Model.CNIC) ? Model.CNIC : "—")</span>
                    </li>
                    <li class="flex justify-between">
                        <span class="font-medium">Company</span>
                        <span class="text-gray-500">@Model.Company?.CompanyName</span>
                    </li>
                </ul>

                <div class="mt-6 flex gap-3">
                    @if (User.IsInRole("Admin"))
                    {
                        <a asp-controller="User" asp-action="EditEmployee" asp-route-id="@Model.Id"
                           class="flex-1 inline-flex items-center justify-center rounded-xl bg-indigo-600 text-white px-4 py-2 hover:bg-indigo-700 transition">
                            Edit Employee
                        </a>
                    }
                    else if (User.IsInRole("Admin"))
                    {
                        <a asp-controller="User" asp-action="GrantAccess" asp-route-employeeId="@Model.Id"
                           class="flex-1 inline-flex items-center justify-center rounded-xl bg-emerald-600 text-white px-4 py-2 hover:bg-emerald-700 transition">
                            ➕ Grant Access
                        </a>
                    }
                </div>
            </div>
        </aside>

        <!-- Right: Profile form & password -->
        <main class="lg:col-span-8">
            <form asp-controller="User" asp-action="Profile" method="post" enctype="multipart/form-data" class="space-y-6 bg-white rounded-2xl shadow p-6">
                <input type="hidden" asp-for="Id" />
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label asp-for="FirstName" class="block text-sm font-medium text-gray-700">First name</label>
                        <input asp-for="FirstName" class="mt-1 block w-full rounded-xl border border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                        <span asp-validation-for="FirstName" class="text-xs text-red-500"></span>
                    </div>

                    <div>
                        <label asp-for="LastName" class="block text-sm font-medium text-gray-700">Last name</label>
                        <input asp-for="LastName" class="mt-1 block w-full rounded-xl border border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                        <span asp-validation-for="LastName" class="text-xs text-red-500"></span>
                    </div>

                    <div>
                        <label asp-for="Designation" class="block text-sm font-medium text-gray-700">Designation</label>
                        <input asp-for="Designation" class="mt-1 block w-full rounded-xl border border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                    </div>

                    <div>
                        <label asp-for="Mobile" class="block text-sm font-medium text-gray-700">Mobile</label>
                        <input asp-for="Mobile" class="mt-1 block w-full rounded-xl border border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                    </div>

                    <div>
                        <label asp-for="Email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input asp-for="Email" type="email" class="mt-1 block w-full rounded-xl border border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                        <span asp-validation-for="Email" class="text-xs text-red-500"></span>
                    </div>

                    <div>
                        <label asp-for="CNIC" class="block text-sm font-medium text-gray-700">CNIC</label>
                        <input asp-for="CNIC" class="mt-1 block w-full rounded-xl border border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                        <span asp-validation-for="CNIC" class="text-xs text-red-500"></span>
                    </div>

                    <div class="md:col-span-2">
                        <label asp-for="Address" class="block text-sm font-medium text-gray-700">Address</label>
                        <input asp-for="Address" class="mt-1 block w-full rounded-xl border border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                    </div>
                </div>

                <div class="flex items-center gap-6">
                    <div class="flex-shrink-0">
                        <img id="preview" src="@(Model.ProfilePictureUrl ?? "/images/user.jpg")" alt="profile" class="h-20 w-20 rounded-full object-cover border border-gray-200" />
                    </div>

                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700">Profile picture</label>
                        <input asp-for="ImageFile" type="file" accept="image/*" class="mt-2 block text-sm" />
                        <p class="text-xs text-gray-500 mt-1">JPG / PNG / WEBP. Max 2MB.</p>
                    </div>
                </div>

                <!-- Password change area -->
                <div class="mt-4 border-t pt-4">
                    @if (Model.ApplicationUser != null)
                    {
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">Password</h3>

                        @* If admin and editing other user -> show only new password reset *@
                        @if (User.IsInRole("Admin") && Model.ApplicationUserId != (User.Identity?.Name ?? null))
                        {
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">New password</label>
                                    <input name="newPassword" type="password" class="mt-1 block w-full rounded-xl border border-gray-300 px-4 py-2" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Confirm password</label>
                                    <input name="confirmPassword" type="password" class="mt-1 block w-full rounded-xl border border-gray-300 px-4 py-2" />
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">As admin you can reset this employee's password.</p>
                        }
                        else
                        {
                            @* normal user changing own password requires current password *@
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Current password</label>
                                    <input name="currentPassword" type="password" class="mt-1 block w-full rounded-xl border border-gray-300 px-4 py-2" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">New password</label>
                                    <input name="newPassword" type="password" class="mt-1 block w-full rounded-xl border border-gray-300 px-4 py-2" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Confirm new</label>
                                    <input name="confirmPassword" type="password" class="mt-1 block w-full rounded-xl border border-gray-300 px-4 py-2" />
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="flex items-center justify-between">
                            <p class="text-sm text-gray-600">This employee does not have system access.</p>
                            @if (User.IsInRole("Admin"))
                            {
                                <a asp-controller="User" asp-action="GrantAccess" asp-route-employeeId="@Model.Id"
                                   class="inline-flex items-center px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 transition">
                                    Grant Access
                                </a>
                            }
                        </div>
                    }
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <a asp-controller="User" asp-action="Index" class="px-4 py-2 rounded-xl bg-gray-100 text-gray-700 hover:bg-gray-200">Cancel</a>
                    <button type="submit" class="px-6 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">Save Changes</button>
                </div>
            </form>
        </main>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // image preview for both card + form preview
        (function () {
            const input = document.querySelector('input[type="file"][name="ImageFile"], input[type="file"][asp-for="ImageFile"]');
            const preview = document.getElementById('preview');
            const card = document.getElementById('cardProfileImg');
            if (!input) return;
            input.addEventListener('change', function () {
                const file = this.files && this.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function (e) {
                    if (preview) preview.src = e.target.result;
                    if (card) card.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        })();
    </script>
}
